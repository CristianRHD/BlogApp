@page "/admin/users"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using BlogApp.Data
@using BlogApp.Services
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer
@using System.Security.Claims
@using BlogApp.Components
@using BlogApp.Entidades

@inject BlogApp.Services.BlogService _blogService
@inject UserManager<ApplicationUser> _userManager
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Gestión de Usuarios</PageTitle>

<h1>Gestión de Usuarios</h1>
<p class="text-muted">Lista completa de usuarios del sistema. (Total: @_users?.Count)</p>

@if (_users == null || _allRoleNames == null)
{
    <p><em>Cargando usuarios y roles...</em></p>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Nombre de Usuario</th>
                <th>Email</th>
                <th>Roles Actuales</th>
                <th style="width: 350px;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in _users)
            {
                <tr>
                    <td>@user.UserName</td>
                    <td>@user.Email</td>
                    <td>
                        @if (_userRoles.ContainsKey(user.Id))
                        {
                            @(string.Join(", ", _userRoles[user.Id]))
                        }
                    </td>
                    <td class="d-flex align-items-center flex-wrap gap-2">

                        <button class="btn btn-sm btn-info" @onclick="() => OpenRoleModal(user)">
                            Asignar Roles
                        </button>

                        
                        <a class="btn btn-sm btn-warning" href="/admin/posts/@user.Id">
                            Moderar Posts
                        </a>

                        <button class="btn btn-sm btn-secondary me-2" @onclick='() => OpenConfirmationModal("Eliminar Comentarios", $"¿Estás seguro de ELIMINAR TODOS los comentarios de {user.UserName}? La cuenta y los posts se mantendrán.", "Sí, Eliminar Comentarios", "delete_comments", user)'>
                            Eliminar Comentarios
                        </button>

                        @if (user.Id != _currentUserId)
                        {
                            <button class="btn btn-sm btn-danger" @onclick='() => OpenConfirmationModal("Eliminar Usuario", $"¿Estás seguro de ELIMINAR PERMANENTEMENTE al usuario {user.UserName} y todo su contenido?", "Sí, Eliminar Usuario", "delete_user", user)'>
                                Eliminar Usuario y Contenido
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}


@if (_isRoleModalOpen && _selectedUser != null)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Roles para @_selectedUser.UserName</h5>
                    <button type="button" class="btn-close" @onclick="CloseRoleModal"></button>
                </div>
                <div class="modal-body">
                    <p>Selecciona los roles que debe tener este usuario:</p>

                    @if (_allRoleNames != null)
                    {
                        @foreach (var roleName in _allRoleNames)
                        {
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="@roleName"
                                       checked="@_selectedRoles.Contains(roleName)"
                                       @onchange="() => ToggleRole(roleName)">
                                <label class="form-check-label" for="@roleName">
                                    @roleName
                                </label>
                            </div>
                        }
                    }

                    @if (!string.IsNullOrEmpty(_roleMessage))
                    {
                        <div class="mt-3 text-danger">@_roleMessage</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRoleModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveUserRoles">Guardar Roles</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}


<ConfirmationModal ShowModal="_showConfirmModal"
                   Title="@_modalTitle"
                   Message="@_modalMessage"
                   ConfirmText="@_modalConfirmText"
                   OnConfirmation="HandleModalConfirmation" />


@code {
    private List<ApplicationUser>? _users;
    private List<string>? _allRoleNames;
    private Dictionary<string, IList<string>> _userRoles = new();
    private string? _currentUserId;

    private bool _isRoleModalOpen;


    private ApplicationUser? _selectedUser;
    private HashSet<string> _selectedRoles = new();
    private string? _roleMessage;

    private bool _showConfirmModal;
    private string _modalTitle = "";
    private string _modalMessage = "";
    private string _modalConfirmText = "";
    private string _actionType = "";
    private ApplicationUser? _userContext;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        try
        {
            await LoadUsersAndRolesAsync();
        }
        catch (UnauthorizedAccessException)
        {
            NavigationManager.NavigateTo("/Account/AccessDenied", forceLoad: true);
        }
    }

    private async Task LoadUsersAndRolesAsync()
    {
        _users = await _blogService.GetAllUsersAsync();
        _allRoleNames = await _blogService.GetAllRoleNamesAsync();

        _userRoles.Clear();
        foreach (var user in _users)
        {
            var roles = await _blogService.GetUserRolesAsync(user);
            _userRoles[user.Id] = roles;
        }
    }

    private void OpenConfirmationModal(string title, string message, string confirmText, string action, ApplicationUser user)
    {
        _modalTitle = title;
        _modalMessage = message;
        _modalConfirmText = confirmText;
        _actionType = action;
        _userContext = user;
        _showConfirmModal = true;
    }


    private void OpenRoleModal(ApplicationUser user)
    {
        _selectedUser = user;
        _selectedRoles = new HashSet<string>(_userRoles.ContainsKey(user.Id) ? _userRoles[user.Id] : new List<string>());
        _roleMessage = null;
        _isRoleModalOpen = true;
    }

    private void CloseRoleModal()
    {
        _isRoleModalOpen = false;
        _selectedUser = null;
    }

    private void ToggleRole(string roleName)
    {
        if (_selectedRoles.Contains(roleName))
        {
            _selectedRoles.Remove(roleName);
        }
        else
        {
            _selectedRoles.Add(roleName);
        }
    }

    private async Task SaveUserRoles()
    {
        if (_selectedUser == null) return;

        var result = await _blogService.UpdateUserRolesAsync(_selectedUser, _selectedRoles);

        if (result.Succeeded)
        {
            await LoadUsersAndRolesAsync();
            CloseRoleModal();
        }
        else
        {
            _roleMessage = $"Error al guardar roles: {string.Join(", ", result.Errors.Select(e => e.Description))}";
        }
    }

   

    private async Task HandleModalConfirmation(bool confirmed)
    {
        _showConfirmModal = false;
        if (!confirmed || _userContext == null) return;

        try
        {
            if (_actionType == "delete_comments")
            {
                await DeleteOnlyComments(_userContext);
            }
            else if (_actionType == "delete_user")
            {
                await DeleteUserAndContent(_userContext);
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            _userContext = null;
        }
    }

    private async Task DeleteOnlyComments(ApplicationUser userToDelete)
    {
        try
        {
            
            await JSRuntime.InvokeVoidAsync("alert", $"Todos los comentarios de '{userToDelete.UserName}' han sido eliminados con éxito.");
            StateHasChanged();
        }
        catch (UnauthorizedAccessException)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Error: No tienes permisos para esta acción.");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Ocurrió un error inesperado al eliminar comentarios: {ex.Message}");
        }
    }


    private async Task DeleteUserAndContent(ApplicationUser userToDelete)
    {
        try
        {
            await _blogService.DeleteAllPostsByUserAsync(userToDelete.Id);
            

            var result = await _userManager.DeleteAsync(userToDelete);

            if (result.Succeeded)
            {
                _users?.Remove(userToDelete);
                StateHasChanged();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error al eliminar el usuario: {string.Join(", ", result.Errors.Select(e => e.Description))}");
            }
        }
        catch (UnauthorizedAccessException)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Error: No tienes permisos para esta acción.");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Ocurrió un error inesperado: {ex.Message}");
        }
    }
}